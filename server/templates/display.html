<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pi Calendar Display</title>
    <link rel="stylesheet" href="/static/styles.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Calendar</h1>
            <div class="view-controls">
                <button class="view-btn" onclick="changeView('day')">Day</button>
                <button class="view-btn" onclick="changeView('week')">Week</button>
                <button class="view-btn active" onclick="changeView('month')">Month</button>
            </div>
        </div>

        <div class="nav-controls">
            <button class="nav-btn" onclick="navigate(-1)">← Prev</button>
            <span class="current-period" id="currentPeriod"></span>
            <button class="nav-btn" onclick="navigate(1)">Next →</button>
            <button class="nav-btn" onclick="goToToday()">Today</button>
        </div>

        <div id="calendarContent">
            <div class="loading">Loading events</div>
        </div>
    </div>

    <script>
        let currentView = 'month';
        let currentDate = new Date();
        let events = [];

        document.addEventListener('DOMContentLoaded', () => {
            loadEvents();
            setInterval(loadEvents, 5 * 60 * 1000);
        });

        async function loadEvents() {
            try {
                const startDate = new Date();
                startDate.setDate(startDate.getDate() - 60);
                startDate.setHours(0, 0, 0, 0);

                const endDate = new Date();
                endDate.setDate(endDate.getDate() + 120);
                endDate.setHours(23, 59, 59, 999);

                const params = new URLSearchParams({
                    start_date: startDate.toISOString(),
                    end_date: endDate.toISOString()
                });

                const response = await fetch(`/api/events?${params}`);
                const data = await response.json();
                events = data.events || [];
                console.log(`Loaded ${events.length} events`);
                renderCalendar();
            } catch (error) {
                console.error('Error loading events:', error);
                document.getElementById('calendarContent').innerHTML =
                    '<div class="error">Error loading events. Retrying...</div>';
            }
        }

        function changeView(view) {
            currentView = view;
            document.querySelectorAll('.view-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            renderCalendar();
        }

        function navigate(direction) {
            if (currentView === 'day') {
                currentDate.setDate(currentDate.getDate() + direction);
            } else if (currentView === 'week') {
                currentDate.setDate(currentDate.getDate() + (direction * 7));
            } else if (currentView === 'month') {
                currentDate.setMonth(currentDate.getMonth() + direction);
            }
            renderCalendar();
        }

        function goToToday() {
            currentDate = new Date();
            renderCalendar();
        }

        function goToDate(year, month, day) {
            currentDate = new Date(year, month, day);
            currentView = 'day';
            document.querySelectorAll('.view-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.view-btn')[0].classList.add('active');
            renderCalendar();
        }

        function renderCalendar() {
            if (currentView === 'day') {
                renderDayView();
            } else if (currentView === 'week') {
                renderWeekView();
            } else if (currentView === 'month') {
                renderMonthView();
            }
        }

        function parseEventDate(dateStr) {
            return new Date(dateStr);
        }

        function formatTime(date) {
            return date.toLocaleTimeString('en-US', {
                hour: 'numeric',
                minute: '2-digit',
                hour12: true
            });
        }

        function isSameDay(date1, date2) {
            return date1.getFullYear() === date2.getFullYear() &&
                   date1.getMonth() === date2.getMonth() &&
                   date1.getDate() === date2.getDate();
        }

        function renderDayView() {
            const dayEvents = events.filter(e => {
                const eventDate = parseEventDate(e.start_time);
                return isSameDay(eventDate, currentDate);
            });

            const dayName = currentDate.toLocaleDateString('en-US', { weekday: 'long' });
            const dayNum = currentDate.getDate();
            const monthYear = currentDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });

            document.getElementById('currentPeriod').textContent =
                `${dayName}, ${monthYear} ${dayNum}`;

            let html = '<div class="day-view"><div class="day-header">';
            html += `<div class="day-circle">${dayNum}</div>`;
            html += `<div class="day-info"><h2>${dayName}</h2><p>${monthYear}</p></div>`;
            html += '</div>';

            if (dayEvents.length === 0) {
                html += '<div class="no-events">No events on this day</div>';
            } else {
                dayEvents.forEach(event => {
                    const startTime = parseEventDate(event.start_time);
                    const endTime = parseEventDate(event.end_time);
                    const timeStr = event.all_day ? 'All day' :
                        `${formatTime(startTime)} - ${formatTime(endTime)}`;

                    html += `<div class="event-card" style="background: linear-gradient(135deg, ${event.color} 0%, ${event.color}dd 100%)">`;
                    html += `<h3>${event.title}</h3>`;
                    html += `<div class="time">${timeStr}</div>`;
                    if (event.location) {
                        html += `<div class="location">${event.location}</div>`;
                    }
                    html += '</div>';
                });
            }

            html += '</div>';
            document.getElementById('calendarContent').innerHTML = html;
        }

        function renderWeekView() {
            const monday = new Date(currentDate);
            const day = monday.getDay();
            const diff = monday.getDate() - day + (day === 0 ? -6 : 1);
            monday.setDate(diff);

            const sunday = new Date(monday);
            sunday.setDate(sunday.getDate() + 6);

            const startMonth = monday.toLocaleDateString('en-US', { month: 'long' });
            const endMonth = sunday.toLocaleDateString('en-US', { month: 'long' });
            const year = sunday.getFullYear();

            let periodText;
            if (startMonth === endMonth) {
                periodText = `${startMonth} ${monday.getDate()}-${sunday.getDate()}, ${year}`;
            } else {
                periodText = `${startMonth} ${monday.getDate()} - ${endMonth} ${sunday.getDate()}, ${year}`;
            }

            document.getElementById('currentPeriod').textContent = periodText;

            let html = '<div class="week-view">';
            html += '<div class="week-grid">';

            const today = new Date();
            const dayNames = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];

            for (let i = 0; i < 7; i++) {
                const day = new Date(monday);
                day.setDate(day.getDate() + i);
                const isToday = isSameDay(day, today);

                const dayEvents = events.filter(e => {
                    const eventDate = parseEventDate(e.start_time);
                    return isSameDay(eventDate, day);
                });

                html += `<div class="day-column ${isToday ? 'today' : ''}">`;
                html += '<div class="day-header">';
                html += `<div class="day-name">${dayNames[i]}</div>`;
                html += `<div class="day-number ${isToday ? 'today' : ''}">${day.getDate()}</div>`;
                html += '</div>';

                dayEvents.forEach(event => {
                    const startTime = parseEventDate(event.start_time);
                    const timeStr = event.all_day ? 'All day' : formatTime(startTime);

                    html += `<div class="compact-event" style="background: linear-gradient(135deg, ${event.color} 0%, ${event.color}dd 100%)" onclick="goToDate(${day.getFullYear()}, ${day.getMonth()}, ${day.getDate()})">`;
                    html += `<div class="title">${event.title.substring(0, 20)}${event.title.length > 20 ? '...' : ''}</div>`;
                    if (!event.all_day) {
                        html += `<div class="time">${timeStr}</div>`;
                    }
                    html += '</div>';
                });

                html += '</div>';
            }

            html += '</div></div>';
            document.getElementById('calendarContent').innerHTML = html;
        }

        function renderMonthView() {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            const monthName = currentDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });

            document.getElementById('currentPeriod').textContent = monthName;

            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const startingDayOfWeek = firstDay.getDay() === 0 ? 6 : firstDay.getDay() - 1;

            let html = '<div class="month-view">';
            html += '<div class="month-grid">';

            const dayHeaders = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
            dayHeaders.forEach(day => {
                html += `<div class="weekday-header">${day}</div>`;
            });

            for (let i = 0; i < startingDayOfWeek; i++) {
                html += '<div class="month-cell"></div>';
            }

            const today = new Date();

            for (let day = 1; day <= lastDay.getDate(); day++) {
                const cellDate = new Date(year, month, day);
                const isToday = isSameDay(cellDate, today);

                const dayEvents = events.filter(e => {
                    const eventDate = parseEventDate(e.start_time);
                    return isSameDay(eventDate, cellDate);
                });

                html += `<div class="month-cell ${isToday ? 'today' : ''}" onclick="goToDate(${year}, ${month}, ${day})">`;
                html += '<div class="month-date">';
                html += `<span class="date-number ${isToday ? 'today' : ''}">${day}</span>`;
                html += '</div>';

                if (dayEvents.length > 0) {
                    const maxEvents = 3;
                    for (let i = 0; i < Math.min(dayEvents.length, maxEvents); i++) {
                        const event = dayEvents[i];
                        const truncatedTitle = event.title.length > 25
                            ? event.title.substring(0, 25) + '...'
                            : event.title;
                        html += `<div class="month-event ${event.all_day ? 'all-day' : ''}" style="background: linear-gradient(135deg, ${event.color} 0%, ${event.color}dd 100%)">`;
                        html += truncatedTitle;
                        html += '</div>';
                    }

                    if (dayEvents.length > maxEvents) {
                        html += `<div class="more-events">+${dayEvents.length - maxEvents} more</div>`;
                    }
                }

                html += '</div>';
            }

            html += '</div></div>';
            document.getElementById('calendarContent').innerHTML = html;
        }
    </script>
</body>
</html>