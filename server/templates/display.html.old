<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pi Calendar Display</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Helvetica Neue', Arial, sans-serif;
            background: #ffffff;
            overflow: hidden;
        }

        .container {
            width: 100vw;
            height: 100vh;
            padding: 20px;
            overflow-y: auto;
        }

        /* Header */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e9ecef;
        }

        .header h1 {
            font-size: 24px;
            color: #212529;
        }

        .view-controls {
            display: flex;
            gap: 10px;
        }

        .view-btn {
            padding: 8px 16px;
            border: none;
            background: #f8f9fa;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.2s;
        }

        .view-btn:hover {
            background: #e9ecef;
        }

        .view-btn.active {
            background: #2196f3;
            color: white;
        }

        .nav-controls {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .nav-btn {
            padding: 8px 16px;
            border: none;
            background: #f8f9fa;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
        }

        .nav-btn:hover {
            background: #e9ecef;
        }

        .current-period {
            font-size: 16px;
            font-weight: 600;
            color: #212529;
        }

        /* Day View */
        .day-view .day-header {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 30px;
        }

        .day-circle {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: #2196f3;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
            font-weight: bold;
        }

        .day-info h2 {
            font-size: 20px;
            margin-bottom: 5px;
            color: #212529;
        }

        .day-info p {
            color: #6c757d;
            font-size: 14px;
        }

        .event-card {
            background: #2196f3;
            border-radius: 12px;
            padding: 18px;
            margin-bottom: 15px;
            color: white;
            box-shadow: 3px 3px 0 rgba(0,0,0,0.05);
        }

        .event-card h3 {
            font-size: 16px;
            margin-bottom: 8px;
        }

        .event-card .time {
            font-size: 13px;
            opacity: 0.9;
            margin-bottom: 4px;
        }

        .event-card .location {
            font-size: 12px;
            opacity: 0.85;
        }

        /* Week View */
        .week-view .week-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .week-view .week-header h2 {
            font-size: 20px;
            color: #212529;
            margin-bottom: 25px;
        }

        .week-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            background: #e9ecef;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            overflow: hidden;
        }

        .day-column {
            background: white;
            padding: 15px 8px;
            min-height: 250px;
        }

        .day-column.today {
            background: #e3f2fd;
        }

        .day-header {
            text-align: center;
            margin-bottom: 15px;
        }

        .day-name {
            font-size: 11px;
            color: #6c757d;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 5px;
        }

        .day-number {
            font-size: 16px;
            font-weight: bold;
            color: #212529;
            width: 32px;
            height: 32px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }

        .day-number.today {
            background: #2196f3;
            color: white;
        }

        .compact-event {
            background: #2196f3;
            border-radius: 8px;
            padding: 8px;
            margin-bottom: 8px;
            color: white;
            font-size: 11px;
            box-shadow: 2px 2px 0 rgba(0,0,0,0.05);
            cursor: pointer;
            transition: transform 0.1s;
        }

        .compact-event:hover {
            transform: translateY(-2px);
            box-shadow: 3px 3px 0 rgba(0,0,0,0.1);
        }

        .compact-event .title {
            font-weight: 600;
            margin-bottom: 3px;
        }

        .compact-event .time {
            font-size: 10px;
            opacity: 0.9;
        }

        /* Month View */
        .month-view .month-header {
            text-align: center;
            margin-bottom: 25px;
        }

        .month-view .month-header h2 {
            font-size: 20px;
            color: #212529;
        }

        .month-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            background: #e9ecef;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            overflow: hidden;
        }

        .weekday-header {
            background: white;
            padding: 10px;
            text-align: center;
            font-size: 11px;
            font-weight: 600;
            color: #6c757d;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .month-cell {
            background: white;
            padding: 8px;
            min-height: 100px;
            position: relative;
            cursor: pointer;
            transition: background 0.2s;
        }

        .month-cell:hover {
            background: #f8f9fa;
        }

        .month-cell.today {
            background: #e3f2fd;
        }

        .month-cell.today:hover {
            background: #d1e9fc;
        }

        .month-date {
            text-align: right;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .month-date .date-number {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 28px;
            height: 28px;
            border-radius: 50%;
        }

        .month-date .date-number.today {
            background: #2196f3;
            color: white;
        }

        .month-event {
            background: #2196f3;
            color: white;
            padding: 4px 6px;
            margin-bottom: 4px;
            border-radius: 4px;
            font-size: 10px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .month-event.all-day {
            opacity: 0.9;
        }

        .more-events {
            font-size: 9px;
            color: #6c757d;
            text-align: center;
            margin-top: 4px;
            font-weight: 600;
        }

        .view-content {
            display: none;
        }

        .view-content.active {
            display: block;
        }

        .no-events {
            text-align: center;
            padding: 60px 20px;
            color: #6c757d;
            font-size: 16px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #6c757d;
        }

        .error {
            text-align: center;
            padding: 40px;
            color: #dc3545;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Calendar</h1>
            <div class="view-controls">
                <button class="view-btn" onclick="changeView('day')">Day</button>
                <button class="view-btn" onclick="changeView('week')">Week</button>
                <button class="view-btn active" onclick="changeView('month')">Month</button>
            </div>
        </div>

        <div class="nav-controls">
            <button class="nav-btn" onclick="navigate(-1)">← Prev</button>
            <span class="current-period" id="currentPeriod"></span>
            <button class="nav-btn" onclick="navigate(1)">Next →</button>
            <button class="nav-btn" onclick="goToToday()">Today</button>
        </div>

        <div id="calendarContent" style="margin-top: 20px;">
            <div class="loading">Loading events...</div>
        </div>
    </div>

    <script>
        let currentView = 'month';
        let currentDate = new Date();
        let events = [];

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadEvents();
            setInterval(loadEvents, 5 * 60 * 1000); // Refresh every 5 minutes
        });

        async function loadEvents() {
            try {
                // Calculate a wide date range to get all relevant events
                // Get events from 60 days ago to 120 days in the future
                const startDate = new Date();
                startDate.setDate(startDate.getDate() - 60);
                startDate.setHours(0, 0, 0, 0);

                const endDate = new Date();
                endDate.setDate(endDate.getDate() + 120);
                endDate.setHours(23, 59, 59, 999);

                // Build query string
                const params = new URLSearchParams({
                    start_date: startDate.toISOString(),
                    end_date: endDate.toISOString()
                });

                const response = await fetch(`/api/events?${params}`);
                const data = await response.json();
                events = data.events || [];
                console.log(`Loaded ${events.length} events`);
                renderCalendar();
            } catch (error) {
                console.error('Error loading events:', error);
                document.getElementById('calendarContent').innerHTML =
                    '<div class="error">Error loading events. Retrying...</div>';
            }
        }

        function changeView(view) {
            currentView = view;
            document.querySelectorAll('.view-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            renderCalendar();
        }

        function navigate(direction) {
            if (currentView === 'day') {
                currentDate.setDate(currentDate.getDate() + direction);
            } else if (currentView === 'week') {
                currentDate.setDate(currentDate.getDate() + (direction * 7));
            } else if (currentView === 'month') {
                currentDate.setMonth(currentDate.getMonth() + direction);
            }
            renderCalendar();
        }

        function goToToday() {
            currentDate = new Date();
            renderCalendar();
        }

        function goToDate(year, month, day) {
            currentDate = new Date(year, month, day);
            currentView = 'day';
            document.querySelectorAll('.view-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.view-btn')[0].classList.add('active'); // Day button
            renderCalendar();
        }

        function renderCalendar() {
            if (currentView === 'day') {
                renderDayView();
            } else if (currentView === 'week') {
                renderWeekView();
            } else if (currentView === 'month') {
                renderMonthView();
            }
        }

        function parseEventDate(dateStr) {
            return new Date(dateStr);
        }

        function formatTime(date) {
            return date.toLocaleTimeString('en-US', {
                hour: 'numeric',
                minute: '2-digit',
                hour12: true
            });
        }

        function isSameDay(date1, date2) {
            return date1.getFullYear() === date2.getFullYear() &&
                   date1.getMonth() === date2.getMonth() &&
                   date1.getDate() === date2.getDate();
        }

        function renderDayView() {
            const dayEvents = events.filter(e => {
                const eventDate = parseEventDate(e.start_time);
                return isSameDay(eventDate, currentDate);
            });

            const dayName = currentDate.toLocaleDateString('en-US', { weekday: 'long' });
            const dayNum = currentDate.getDate();
            const monthYear = currentDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });

            document.getElementById('currentPeriod').textContent =
                `${dayName}, ${monthYear} ${dayNum}`;

            let html = '<div class="day-view"><div class="day-header">';
            html += `<div class="day-circle">${dayNum}</div>`;
            html += `<div class="day-info"><h2>${dayName}</h2><p>${monthYear}</p></div>`;
            html += '</div>';

            if (dayEvents.length === 0) {
                html += '<div class="no-events">No events on this day</div>';
            } else {
                dayEvents.forEach(event => {
                    const startTime = parseEventDate(event.start_time);
                    const endTime = parseEventDate(event.end_time);
                    const timeStr = event.all_day ? 'All day' :
                        `${formatTime(startTime)} - ${formatTime(endTime)}`;

                    html += `<div class="event-card" style="background: ${event.color}">`;
                    html += `<h3>${event.title}</h3>`;
                    html += `<div class="time">${timeStr}</div>`;
                    if (event.location) {
                        html += `<div class="location">${event.location}</div>`;
                    }
                    html += '</div>';
                });
            }

            html += '</div>';
            document.getElementById('calendarContent').innerHTML = html;
        }

        function renderWeekView() {
            const monday = new Date(currentDate);
            const day = monday.getDay();
            const diff = monday.getDate() - day + (day === 0 ? -6 : 1);
            monday.setDate(diff);

            const sunday = new Date(monday);
            sunday.setDate(sunday.getDate() + 6);

            const startMonth = monday.toLocaleDateString('en-US', { month: 'long' });
            const endMonth = sunday.toLocaleDateString('en-US', { month: 'long' });
            const year = sunday.getFullYear();

            let periodText;
            if (startMonth === endMonth) {
                periodText = `${startMonth} ${monday.getDate()}-${sunday.getDate()}, ${year}`;
            } else {
                periodText = `${startMonth} ${monday.getDate()} - ${endMonth} ${sunday.getDate()}, ${year}`;
            }

            document.getElementById('currentPeriod').textContent = periodText;

            let html = '<div class="week-view">';
            html += '<div class="week-grid">';

            const today = new Date();
            const dayNames = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];

            for (let i = 0; i < 7; i++) {
                const day = new Date(monday);
                day.setDate(day.getDate() + i);
                const isToday = isSameDay(day, today);

                const dayEvents = events.filter(e => {
                    const eventDate = parseEventDate(e.start_time);
                    return isSameDay(eventDate, day);
                });

                html += `<div class="day-column ${isToday ? 'today' : ''}">`;
                html += '<div class="day-header">';
                html += `<div class="day-name">${dayNames[i]}</div>`;
                html += `<div class="day-number ${isToday ? 'today' : ''}">${day.getDate()}</div>`;
                html += '</div>';

                dayEvents.forEach(event => {
                    const startTime = parseEventDate(event.start_time);
                    const timeStr = event.all_day ? 'All day' : formatTime(startTime);

                    html += `<div class="compact-event" style="background: ${event.color}" onclick="goToDate(${day.getFullYear()}, ${day.getMonth()}, ${day.getDate()})">`;
                    html += `<div class="title">${event.title.substring(0, 20)}${event.title.length > 20 ? '...' : ''}</div>`;
                    if (!event.all_day) {
                        html += `<div class="time">${timeStr}</div>`;
                    }
                    html += '</div>';
                });

                html += '</div>';
            }

            html += '</div></div>';
            document.getElementById('calendarContent').innerHTML = html;
        }

        function renderMonthView() {
    const year = currentDate.getFullYear();
    const month = currentDate.getMonth();
    const monthName = currentDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });

    document.getElementById('currentPeriod').textContent = monthName;

    const firstDay = new Date(year, month, 1);
    const lastDay = new Date(year, month + 1, 0);
    const startingDayOfWeek = firstDay.getDay() === 0 ? 6 : firstDay.getDay() - 1;

    let html = '<div class="month-view">';
    html += '<div class="month-grid">';

    // Day headers
    const dayHeaders = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
    dayHeaders.forEach(day => {
        html += `<div class="weekday-header">${day}</div>`;
    });

    // Empty cells before first day
    for (let i = 0; i < startingDayOfWeek; i++) {
        html += '<div class="month-cell"></div>';
    }

    const today = new Date();

    // Days of month
    for (let day = 1; day <= lastDay.getDate(); day++) {
        const cellDate = new Date(year, month, day);
        const isToday = isSameDay(cellDate, today);

        const dayEvents = events.filter(e => {
            const eventDate = parseEventDate(e.start_time);
            return isSameDay(eventDate, cellDate);
        });

        html += `<div class="month-cell ${isToday ? 'today' : ''}" onclick="goToDate(${year}, ${month}, ${day})">`;
        html += '<div class="month-date">';
        html += `<span class="date-number ${isToday ? 'today' : ''}">${day}</span>`;
        html += '</div>';

        if (dayEvents.length > 0) {
            // Show up to 3 events
            const maxEvents = 3;
            for (let i = 0; i < Math.min(dayEvents.length, maxEvents); i++) {
                const event = dayEvents[i];
                const truncatedTitle = event.title.length > 25
                    ? event.title.substring(0, 25) + '...'
                    : event.title;
                html += `<div class="month-event ${event.all_day ? 'all-day' : ''}" style="background: ${event.color}">`;
                html += truncatedTitle;
                html += '</div>';
            }

            if (dayEvents.length > maxEvents) {
                html += `<div class="more-events">+${dayEvents.length - maxEvents} more</div>`;
            }
        }

        html += '</div>';
    }

    html += '</div></div>';
    document.getElementById('calendarContent').innerHTML = html;
}
    </script>
</body>
</html>